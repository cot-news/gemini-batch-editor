async function startBatchProcess() {
    const geminiUrl = "https://yqyfmcrtvcih.us-west-1.clawcloudrun.com/v1beta"; // 你的反代地址
    const hfUrl = "https://你的名字-my-ai-remover.hf.space/process_smart"; // 你的 HF 地址
    const apiKey = document.getElementById('apiKey').value;

    for (let item of queue) {
        item.status = 'processing';
        renderGrid();

        try {
            // --- 阶段 1: 问大脑 (Gemini) ---
            const base64 = await toBase64(item.file);
            const geminiRes = await fetch(`${geminiUrl}/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: "你是一个专业的摄影后期。请分析这张产品图，为了让它抠图后更有立体感，请给出建议的阴影参数：offset_x (水平偏移), offset_y (垂直偏移), blur (模糊度 5-20), opacity (透明度 0-1)。请只返回 JSON 格式，例如: {\"offset_x\": 10, \"offset_y\": 15, \"blur\": 10, \"opacity\": 0.5}" },
                            { inline_data: { mime_type: item.file.type, data: base64.split(',')[1] } }
                        ]
                    }]
                })
            });
            const geminiData = await geminiRes.json();
            // 提取 JSON 字符串（处理 Gemini 可能返回的 Markdown 代码块）
            const rawText = geminiData.candidates[0].content.parts[0].text;
            const shadowParams = rawText.match(/\{.*\}/s)[0]; 

            // --- 阶段 2: 传给双手 (Hugging Face) ---
            const fd = new FormData();
            fd.append('file', item.file);
            fd.append('shadow_params', shadowParams); // 把大脑的指令传过去

            const hfRes = await fetch(hfUrl, { method: 'POST', body: fd });
            const blob = await hfRes.blob();
            item.resultUrl = URL.createObjectURL(blob);
            item.status = 'success';

        } catch (e) {
            console.error(e);
            item.status = 'error';
        }
        renderGrid();
    }
}
