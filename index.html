<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini 智能抠图 - 隐私增强版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#3B82F6', success: '#10B981', danger: '#EF4444', dark: '#0F172A' }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .glass { backdrop-filter: blur(12px); background: rgba(255, 255, 255, 0.7); border: 1px solid rgba(255, 255, 255, 0.3); }
            .input-focus { @apply border-primary ring-4 ring-primary/10; }
        }
        /* 隐藏默认占位符的样式 */
        ::placeholder { color: #94a3b8; font-size: 0.8rem; }
    </style>
</head>
<body class="bg-[#F8FAFC] min-h-screen font-sans text-slate-900">

    <nav class="glass sticky top-0 z-50 px-8 py-4 flex justify-between items-center border-b border-slate-200">
        <div class="flex items-center space-x-3">
            <div class="bg-primary p-2 rounded-xl text-white shadow-lg">
                <i class="fa fa-shield text-xl"></i>
            </div>
            <span class="text-xl font-black tracking-tight">Gemini <span class="text-primary">Batch v4.5</span></span>
        </div>
        <div class="text-[10px] font-bold text-slate-400 bg-white px-3 py-1 rounded-full border border-slate-100">
            SECURE CONFIGURATION ENABLED
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- 左侧：隐私配置面板 -->
            <div class="lg:col-span-4 space-y-6">
                <div class="bg-white rounded-[2.5rem] p-8 shadow-sm border border-slate-100">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-lg text-slate-700 italic">Configuration</h3>
                        <i class="fa fa-lock text-slate-300"></i>
                    </div>
                    
                    <div class="space-y-5">
                        <!-- 反代地址 -->
                        <div class="relative group">
                            <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block tracking-wider">Gemini 反代地址</label>
                            <input type="password" id="geminiProxy" placeholder="●●●●●● 系统默认地址已加载" class="w-full px-4 py-2.5 rounded-xl bg-slate-50 border border-transparent focus:bg-white focus:border-primary outline-none text-xs transition-all pr-10">
                            <button onclick="toggleMask('geminiProxy')" class="absolute right-3 top-7 text-slate-300 hover:text-primary transition-colors">
                                <i class="fa fa-eye"></i>
                            </button>
                        </div>

                        <!-- API Key -->
                        <div class="relative group">
                            <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block tracking-wider">Gemini API Key</label>
                            <input type="password" id="apiKey" placeholder="●●●●●● 系统默认 Key 已加载" class="w-full px-4 py-2.5 rounded-xl bg-slate-50 border border-transparent focus:bg-white focus:border-primary outline-none text-xs transition-all pr-10">
                            <button onclick="toggleMask('apiKey')" class="absolute right-3 top-7 text-slate-300 hover:text-primary transition-colors">
                                <i class="fa fa-eye"></i>
                            </button>
                        </div>

                        <!-- 后端地址 -->
                        <div class="relative group">
                            <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block tracking-wider">Hugging Face 后端</label>
                            <input type="password" id="hfBackend" placeholder="●●●●●● 系统默认后端已加载" class="w-full px-4 py-2.5 rounded-xl bg-slate-50 border border-transparent focus:bg-white focus:border-primary outline-none text-xs transition-all pr-10">
                            <button onclick="toggleMask('hfBackend')" class="absolute right-3 top-7 text-slate-300 hover:text-primary transition-colors">
                                <i class="fa fa-eye"></i>
                            </button>
                        </div>

                        <div class="py-2">
                            <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block tracking-wider">选择模型</label>
                            <select id="modelSelect" class="w-full px-4 py-2.5 rounded-xl bg-slate-50 border-none outline-none focus:ring-2 focus:ring-primary text-xs font-bold cursor-pointer">
                                <option value="gemini-1.5-flash">Gemini 1.5 Flash (推荐)</option>
                                <option value="gemini-3-flash-preview">Gemini 3 Flash (最新)</option>
                                <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                            </select>
                        </div>

                        <div id="dropZone" class="border-2 border-dashed border-blue-50 rounded-3xl p-6 text-center bg-blue-50/20 hover:bg-blue-50 transition-all cursor-pointer group" onclick="document.getElementById('fileInput').click()">
                            <input type="file" id="fileInput" multiple accept="image/*" class="hidden">
                            <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center mx-auto mb-2 shadow-sm group-hover:scale-110 transition-transform">
                                <i class="fa fa-plus text-primary text-sm"></i>
                            </div>
                            <p class="text-[11px] font-bold text-slate-500 uppercase">选择批量图片</p>
                        </div>

                        <button onclick="startBatchProcess()" id="startBtn" class="w-full bg-primary hover:bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-blue-100 transition-all flex items-center justify-center space-x-2">
                            <i class="fa fa-bolt"></i>
                            <span>执行自动化处理</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 右侧：结果展示 -->
            <div class="lg:col-span-8">
                <div class="bg-white rounded-[2.5rem] p-8 shadow-sm border border-slate-100 min-h-[600px]">
                    <div id="progressArea" class="hidden mb-8">
                        <div class="flex justify-between items-end mb-3">
                            <div>
                                <h4 id="progressText" class="text-primary font-black text-sm uppercase italic tracking-tighter">AI Orchestrating...</h4>
                            </div>
                            <span id="percentText" class="text-2xl font-black text-slate-100">0%</span>
                        </div>
                        <div class="w-full bg-slate-50 h-1.5 rounded-full overflow-hidden">
                            <div id="progressBar" class="bg-primary h-full transition-all duration-700" style="width: 0%"></div>
                        </div>
                    </div>

                    <div id="resultGrid" class="grid grid-cols-2 md:grid-cols-3 gap-6">
                        <div class="col-span-full py-40 text-center opacity-10">
                            <i class="fa fa-microchip text-8xl mb-4"></i>
                            <p class="font-black italic uppercase">System Ready</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- 核心隐私加密存储 (Base64) ---
        // 默认地址仅在代码中，不填入 input 的 value
        const _DEFAULT_CONFIG = {
            p: "aHR0cHM6Ly95cXlmbWNydHZjaWgubXUtd2VzdC0xLmNsYXdjbG91ZHJ1bi5jb20vdjFiZXRh", 
            k: "YWlzdHVkaW8=", 
            b: "aHR0cHM6Ly9uYWlkZC1teS1haS1yZW1vdmVyLmhmLnNwYWNl"
        };

        // 处理“小眼睛”点击
        function toggleMask(id) {
            const el = document.getElementById(id);
            // 如果输入框是空的，说明显示的是占位符，不予查看
            if (el.value === "") {
                alert("默认配置受保护，不可查看。如需更改，请直接输入新地址。");
                return;
            }
            // 如果有输入，则切换显示/隐藏
            el.type = el.type === 'password' ? 'text' : 'password';
        }

        let queue = [];
        let isProcessing = false;

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            queue = [...queue, ...files.map(file => ({
                file: file,
                status: 'ready',
                resultUrl: null,
                log: '待命'
            }))];
            renderGrid();
        });

        function renderGrid() {
            const grid = document.getElementById('resultGrid');
            if (queue.length === 0) return;
            grid.innerHTML = queue.map((item, index) => `
                <div class="relative bg-white rounded-3xl border border-slate-50 overflow-hidden shadow-sm group hover:shadow-xl transition-all duration-500">
                    <img src="${item.resultUrl || URL.createObjectURL(item.file)}" class="w-full aspect-square object-cover ${item.status === 'processing' ? 'scale-110 blur-sm opacity-50' : ''} transition-all duration-700">
                    ${item.status === 'processing' ? `
                        <div class="absolute inset-0 flex flex-col items-center justify-center p-4">
                            <div class="bg-white/90 backdrop-blur-md p-4 rounded-2xl shadow-xl flex flex-col items-center border border-white">
                                <i class="fa fa-spinner fa-spin text-primary text-xl mb-2"></i>
                                <span class="text-[9px] font-black text-slate-500 uppercase">${item.log}</span>
                            </div>
                        </div>
                    ` : ''}
                    ${item.status === 'success' ? `
                        <div class="absolute inset-0 bg-primary/20 opacity-0 group-hover:opacity-100 transition-all flex items-center justify-center">
                            <a href="${item.resultUrl}" download="smart_${item.file.name}" class="bg-white w-10 h-10 rounded-full flex items-center justify-center text-primary shadow-2xl hover:scale-125">
                                <i class="fa fa-download"></i>
                            </a>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        async function startBatchProcess() {
            if (isProcessing || queue.length === 0) return;
            
            // --- 智能读取逻辑 ---
            // 如果 input 为空，则取解码后的默认值；如果不为空，取用户填写的。
            const customKey = document.getElementById('apiKey').value.trim();
            const apiKey = customKey !== "" ? customKey : atob(_DEFAULT_CONFIG.k);

            const customProxy = document.getElementById('geminiProxy').value.trim();
            const geminiUrl = customProxy !== "" ? customProxy : atob(_DEFAULT_CONFIG.p);

            const customBackend = document.getElementById('hfBackend').value.trim();
            const hfUrl = customBackend !== "" ? customBackend : atob(_DEFAULT_CONFIG.b);

            const selectedModel = document.getElementById('modelSelect').value;

            isProcessing = true;
            document.getElementById('progressArea').classList.remove('hidden');

            for (let i = 0; i < queue.length; i++) {
                if (queue[i].status === 'success') continue;

                queue[i].status = 'processing';
                queue[i].log = 'Gemini 视觉分析';
                renderGrid();
                updateProgress(i, queue.length);

                try {
                    const base64 = await toBase64(queue[i].file);
                    const cleanBaseUrl = geminiUrl.replace(/\/$/, ""); 
                    
                    // 1. 调用分析引擎
                    const geminiRes = await fetch(`${cleanBaseUrl}/models/${selectedModel}:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: "分析此图。为了抠图加阴影，请返回阴影参数：offset_x, offset_y, blur (5-20), opacity (0.3-0.6)。只返回纯 JSON" },
                                    { inline_data: { mime_type: queue[i].file.type, data: base64.split(',')[1] } }
                                ]
                            }]
                        })
                    });

                    if (!geminiRes.ok) throw new Error("GEMINI_ERROR");
                    const geminiData = await geminiRes.json();
                    const shadowParams = geminiData.candidates[0].content.parts[0].text.match(/\{.*\}/s)[0]; 

                    // 2. 调用后端执行
                    queue[i].log = '后端算法合成';
                    renderGrid();

                    const fd = new FormData();
                    fd.append('file', queue[i].file);
                    fd.append('shadow_params', shadowParams);

                    const cleanHfUrl = hfUrl.replace(/\/$/, "");
                    const hfRes = await fetch(`${cleanHfUrl}/process_smart`, { method: 'POST', body: fd });
                    if (!hfRes.ok) throw new Error("HF_ERROR");
                    
                    const blob = await hfRes.blob();
                    queue[i].resultUrl = URL.createObjectURL(blob);
                    queue[i].status = 'success';

                } catch (error) {
                    console.error(error);
                    queue[i].status = 'error';
                }
                renderGrid();
                updateProgress(i + 1, queue.length);
            }
            isProcessing = false;
        }

        function toBase64(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
            });
        }

        function updateProgress(cur, total) {
            const percent = Math.round((cur / total) * 100);
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('percentText').innerText = percent + '%';
        }
    </script>
</body>
</html>
