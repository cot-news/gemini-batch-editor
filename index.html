<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Pro 批量抠图工作站</title>
    <!-- 引入样式库 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#3B82F6', success: '#10B981', danger: '#EF4444' }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .glass { backdrop-filter: blur(16px); background: rgba(255, 255, 255, 0.8); border: 1px solid rgba(255, 255, 255, 0.3); }
        }
    </style>
</head>
<body class="bg-[#F3F4F6] min-h-screen font-sans">

    <!-- 导航栏 -->
    <nav class="glass sticky top-0 z-50 px-6 py-4 flex justify-between items-center shadow-sm">
        <div class="flex items-center space-x-3">
            <div class="bg-primary p-2 rounded-xl shadow-lg shadow-blue-200">
                <i class="fa fa-magic text-white text-lg"></i>
            </div>
            <span class="text-xl font-bold tracking-tight text-gray-800">Gemini <span class="text-primary">Batch</span></span>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 py-10">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- 左侧：控制台 -->
            <div class="lg:col-span-4 space-y-6">
                <div class="glass p-6 rounded-3xl shadow-sm">
                    <h3 class="font-bold mb-4 text-gray-700"><i class="fa fa-cog mr-2 text-primary"></i> 任务配置</h3>
                    <input type="password" id="apiKey" placeholder="输入 Gemini API Key (可选)" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-primary outline-none transition-all mb-4">
                    
                    <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-2xl p-6 text-center hover:border-primary transition-all cursor-pointer bg-white/50" onclick="document.getElementById('fileInput').click()">
                        <input type="file" id="fileInput" multiple accept="image/*" class="hidden">
                        <i class="fa fa-cloud-upload text-3xl text-primary mb-2"></i>
                        <p class="text-sm font-bold text-gray-600">点击上传图片</p>
                    </div>

                    <button onclick="startBatchProcess()" id="startBtn" class="w-full mt-6 bg-primary hover:bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-blue-200 transition-all flex items-center justify-center space-x-2">
                        <i class="fa fa-play"></i>
                        <span>开始批量处理</span>
                    </button>
                    
                    <button onclick="location.reload()" class="w-full mt-3 text-gray-400 text-sm hover:text-gray-600">清空所有任务</button>
                </div>
            </div>

            <!-- 右侧：工作区 -->
            <div class="lg:col-span-8">
                <div class="glass rounded-3xl min-h-[500px] p-6 shadow-sm">
                    <div id="progressArea" class="hidden mb-6">
                        <div class="flex justify-between text-sm mb-2 font-bold text-primary">
                            <span id="progressText">准备中...</span>
                            <span id="percentText">0%</span>
                        </div>
                        <div class="w-full bg-gray-100 h-2 rounded-full overflow-hidden">
                            <div id="progressBar" class="bg-primary h-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- 动态生成的图片网格 -->
                    <div id="resultGrid" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="col-span-full py-20 text-center text-gray-300">
                            <i class="fa fa-file-image-o text-5xl mb-4"></i>
                            <p>上传图片后，这里会显示处理结果</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 这里的 <script> 标签非常重要，它告诉浏览器下面是代码逻辑 -->
    <script>
        let queue = [];
        let isProcessing = false;

        // 监听文件上传
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            queue = [...queue, ...files.map(file => ({
                file: file,
                status: 'ready',
                resultUrl: null
            }))];
            renderGrid();
        });

        // 渲染右侧网格
        function renderGrid() {
            const grid = document.getElementById('resultGrid');
            if (queue.length === 0) return;
            
            grid.innerHTML = queue.map((item, index) => `
                <div class="relative aspect-square bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden group">
                    <img src="${item.resultUrl || URL.createObjectURL(item.file)}" class="w-full h-full object-cover ${item.status === 'processing' ? 'opacity-30' : ''}">
                    
                    ${item.status === 'processing' ? `
                        <div class="absolute inset-0 flex items-center justify-center">
                            <i class="fa fa-spinner fa-spin text-primary text-2xl"></i>
                        </div>
                    ` : ''}

                    ${item.status === 'success' ? `
                        <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                            <a href="${item.resultUrl}" download="result_${index}.png" class="bg-white p-3 rounded-full text-primary shadow-xl hover:scale-110 transition-transform">
                                <i class="fa fa-download text-lg"></i>
                            </a>
                        </div>
                        <div class="absolute top-2 right-2 bg-success text-white w-5 h-5 rounded-full flex items-center justify-center text-[10px]">
                            <i class="fa fa-check"></i>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // 批量处理主逻辑
        async function startBatchProcess() {
            if (isProcessing || queue.length === 0) return;
            
            isProcessing = true;
            const apiKey = document.getElementById('apiKey').value;
            document.getElementById('progressArea').classList.remove('hidden');

            for (let i = 0; i < queue.length; i++) {
                if (queue[i].status === 'success') continue;

                queue[i].status = 'processing';
                renderGrid();
                updateProgress(i, queue.length);

                try {
                    // 调用你刚才提供的核心函数
                    const result = await processSingleImage(queue[i].file, apiKey);
                    queue[i].resultUrl = result;
                    queue[i].status = 'success';
                } catch (error) {
                    console.error(error);
                    queue[i].status = 'error';
                }

                renderGrid();
                updateProgress(i + 1, queue.length);
            }
            isProcessing = false;
        }

        // --- 这是你刚才提供的核心函数 ---
        async function processSingleImage(file, key) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('api_key', key);

            // 指向你的 Hugging Face 地址
            const response = await fetch('https://naidd-my-ai-remover.hf.space/process', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) throw new Error("服务器处理失败");
            
            const blob = await response.blob();
            return URL.createObjectURL(blob);
        }
        // --- 核心函数结束 ---

        function updateProgress(cur, total) {
            const percent = Math.round((cur / total) * 100);
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('percentText').innerText = percent + '%';
            document.getElementById('progressText').innerText = `处理中: ${cur} / ${total}`;
        }
    </script>
</body>
</html>
