<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Pro 智能批量抠图工作站</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#3B82F6', secondary: '#10B981', accent: '#6366F1', dark: '#1E293B' },
                    animation: { 'fade-in': 'fadeIn 0.6s ease-in-out', 'slide-up': 'slideUp 0.8s ease-out' }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
            .glass { backdrop-filter: blur(12px); background: rgba(255, 255, 255, 0.7); border: 1px solid rgba(255, 255, 255, 0.3); }
            .card-hover { transition: all 0.3s ease; }
            .card-hover:hover { transform: translateY(-5px); box-shadow: 0 15px 30px -10px rgba(0,0,0,0.1); }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-900 overflow-x-hidden">

    <!-- 导航栏 -->
    <nav class="bg-white/80 backdrop-blur-md border-b border-gray-100 sticky top-0 z-50 px-8 py-4 flex justify-between items-center shadow-sm">
        <div class="flex items-center space-x-3">
            <div class="bg-primary rounded-xl p-2 shadow-lg text-white">
                <i class="fa fa-magic text-xl"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold">Gemini <span class="text-primary font-black uppercase tracking-tighter">Batch</span></h1>
            </div>
        </div>
        <button onclick="toggleAllMasks()" class="text-[10px] font-bold text-primary bg-blue-50 px-4 py-2 rounded-full hover:bg-blue-100 transition-all border border-blue-100">
            <i class="fa fa-eye-slash mr-1"></i> 显示/隐藏敏感地址
        </button>
    </nav>

    <main id="editor" class="max-w-7xl mx-auto px-4 py-12">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
            
            <!-- 控制台 -->
            <div class="lg:col-span-4 space-y-6">
                <div class="bg-white rounded-[2rem] p-8 shadow-xl border border-gray-100">
                    <h3 class="text-lg font-bold mb-6 flex items-center text-dark italic">
                        <i class="fa fa-cog mr-3 text-primary animate-spin-slow"></i> TASK_CONFIG
                    </h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1 block">推理模型</label>
                            <select id="modelSelect" class="w-full px-4 py-3 rounded-2xl bg-gray-50 border-none outline-none focus:ring-2 focus:ring-primary text-xs font-bold cursor-pointer transition-all">
                                <option value="gemini-1.5-flash">Gemini 1.5 Flash (最推荐)</option>
                                <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash Exp</option>
                                <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1 block">Gemini 反代地址</label>
                            <input type="password" id="geminiProxy" placeholder="使用默认混淆预设" class="w-full px-4 py-3 rounded-2xl bg-gray-50 border-none outline-none focus:ring-2 focus:ring-primary text-xs transition-all">
                        </div>

                        <div>
                            <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1 block">Hugging Face 后端</label>
                            <input type="password" id="hfBackend" placeholder="使用默认混淆预设" class="w-full px-4 py-3 rounded-2xl bg-gray-50 border-none outline-none focus:ring-2 focus:ring-primary text-xs transition-all">
                        </div>

                        <div>
                            <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1 block">Gemini API Key</label>
                            <input type="password" id="apiKey" placeholder="在此输入您的 API Key" class="w-full px-4 py-3 rounded-2xl bg-gray-50 border-none outline-none focus:ring-2 focus:ring-primary text-xs shadow-inner">
                        </div>

                        <div id="dropZone" class="border-2 border-dashed border-blue-100 rounded-[2rem] p-8 text-center bg-blue-50/30 hover:bg-blue-50 transition-all cursor-pointer group" onclick="document.getElementById('fileInput').click()">
                            <input type="file" id="fileInput" multiple accept="image/*" class="hidden">
                            <i class="fa fa-plus text-primary text-xl mb-2 group-hover:scale-110 transition-transform"></i>
                            <p class="text-xs font-bold text-gray-600">添加批量图片</p>
                        </div>

                        <button onclick="startBatchProcess()" id="startBtn" class="w-full mt-6 bg-primary hover:bg-blue-600 text-white py-5 rounded-[1.5rem] font-bold shadow-xl shadow-blue-200 transition-all flex items-center justify-center space-x-3">
                            <i class="fa fa-rocket"></i>
                            <span>开始一键智能抠图</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 结果区 -->
            <div class="lg:col-span-8">
                <div class="bg-white rounded-[2rem] p-8 shadow-xl border border-gray-100 min-h-[600px] relative">
                    <div id="progressArea" class="hidden mb-10">
                        <div class="flex justify-between items-end mb-3">
                            <div>
                                <h4 id="progressText" class="text-primary font-black text-lg italic uppercase">AI PROCESSING...</h4>
                                <p class="text-[10px] text-gray-300 uppercase tracking-widest font-bold">Queue Monitor</p>
                            </div>
                            <span id="percentText" class="text-3xl font-black text-gray-100">0%</span>
                        </div>
                        <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden">
                            <div id="progressBar" class="bg-primary h-full transition-all duration-700 ease-out" style="width: 0%"></div>
                        </div>
                    </div>

                    <div id="resultGrid" class="grid grid-cols-2 md:grid-cols-3 gap-6">
                        <div class="col-span-full py-40 text-center opacity-10">
                            <i class="fa fa-braille text-8xl mb-6"></i>
                            <p class="font-black italic uppercase">Results Dashboard</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- 加密逻辑 ---
        const _O_P = "aHR0cHM6Ly95cXlmbWNydHZjaWgubXUtd2VzdC0xLmNsYXdjbG91ZHJ1bi5jb20vdjFiZXRh"; 
        const _O_B = "aHR0cHM6Ly9uYWlkZC1teS1haS1yZW1vdmVyLmhmLnNwYWNl";

        let queue = [];
        let isProcessing = false;

        function toggleAllMasks() {
            const fields = ['geminiProxy', 'hfBackend', 'apiKey'];
            fields.forEach(id => {
                const el = document.getElementById(id);
                el.type = el.type === 'password' ? 'text' : 'password';
            });
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            queue = [...queue, ...files.map(file => ({
                file: file,
                status: 'ready',
                resultUrl: null,
                log: '等待启动'
            }))];
            renderGrid();
        });

        function renderGrid() {
            const grid = document.getElementById('resultGrid');
            if (queue.length === 0) return;
            grid.innerHTML = queue.map((item, index) => `
                <div class="relative bg-white rounded-[2rem] border border-slate-50 overflow-hidden shadow-sm group hover:shadow-xl transition-all duration-500 card-hover">
                    <img src="${item.resultUrl || URL.createObjectURL(item.file)}" class="w-full aspect-square object-cover ${item.status === 'processing' ? 'scale-110 blur-sm opacity-50' : ''} transition-all duration-700">
                    
                    ${item.status === 'processing' ? `
                        <div class="absolute inset-0 flex flex-col items-center justify-center p-4">
                            <div class="bg-white/90 backdrop-blur-md p-4 rounded-2xl shadow-xl border border-white flex flex-col items-center">
                                <i class="fa fa-spinner fa-spin text-primary text-xl mb-2"></i>
                                <span class="text-[9px] font-black text-slate-500 uppercase tracking-tighter">${item.log}</span>
                            </div>
                        </div>
                    ` : ''}

                    ${item.status === 'success' ? `
                        <div class="absolute inset-0 bg-primary/20 opacity-0 group-hover:opacity-100 transition-all flex items-center justify-center">
                            <a href="${item.resultUrl}" download="smart_${item.file.name}" class="bg-white w-12 h-12 rounded-full flex items-center justify-center text-primary shadow-2xl hover:scale-125 transition-transform">
                                <i class="fa fa-download"></i>
                            </a>
                        </div>
                    ` : ''}

                    ${item.status === 'error' ? `
                        <div class="absolute inset-0 bg-red-50/95 flex flex-col items-center justify-center p-4 text-center">
                            <i class="fa fa-exclamation-triangle text-red-500 mb-2"></i>
                            <!-- 核心修复：这里不再写死 Engine Failure，而是动态显示 item.log -->
                            <span class="text-red-600 text-[10px] font-black uppercase tracking-tighter leading-tight">${item.log}</span>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        async function startBatchProcess() {
            if (isProcessing || queue.length === 0) return;
            
            const rawApiKey = document.getElementById('apiKey').value.trim();
            const rawProxy = document.getElementById('geminiProxy').value.trim();
            const rawBackend = document.getElementById('hfBackend').value.trim();

            const apiKey = rawApiKey; 
            const geminiUrl = rawProxy !== "" ? rawProxy : atob(_O_P);
            const hfUrl = rawBackend !== "" ? rawBackend : atob(_O_B);
            const selectedModel = document.getElementById('modelSelect').value;

            if (!apiKey) return alert("错误：请填写 API Key！");

            isProcessing = true;
            document.getElementById('progressArea').classList.remove('hidden');

            for (let i = 0; i < queue.length; i++) {
                if (queue[i].status === 'success') continue;

                queue[i].status = 'processing';
                queue[i].log = '大脑分析中...';
                renderGrid();
                updateProgress(i, queue.length);

                try {
                    const base64 = await toBase64(queue[i].file);
                    const cleanProxy = geminiUrl.replace(/\/$/, "");
                    
                    // 1. 大脑分析 (Gemini)
                    const geminiRes = await fetch(`${cleanProxy}/models/${selectedModel}:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: "分析此图。为了抠图加阴影，请返回阴影参数。只返回纯 JSON: {\"offset_x\": 10, \"offset_y\": 10, \"blur\": 10, \"opacity\": 0.4}" },
                                    { inline_data: { mime_type: queue[i].file.type, data: base64.split(',')[1] } }
                                ]
                            }]
                        })
                    });

                    if (!geminiRes.ok) throw new Error(`Gemini报错 ${geminiRes.status}`);
                    const geminiData = await geminiRes.json();
                    
                    if (!geminiData.candidates) throw new Error("API Key无效或触发安全过滤");
                    
                    let rawText = geminiData.candidates[0].content.parts[0].text;
                    const jsonMatch = rawText.match(/\{.*\}/s);
                    if (!jsonMatch) throw new Error("AI未返回有效参数");
                    const shadowParams = jsonMatch[0]; 

                    // 2. 双手执行 (Hugging Face)
                    queue[i].log = '算法执行中...';
                    renderGrid();

                    const fd = new FormData();
                    fd.append('file', queue[i].file);
                    fd.append('shadow_params', shadowParams);

                    const cleanHf = hfUrl.replace(/\/$/, "");
                    const hfRes = await fetch(`${cleanHf}/process_smart`, { method: 'POST', body: fd });
                    
                    if (!hfRes.ok) throw new Error(`后端报错 ${hfRes.status}`);
                    
                    const blob = await hfRes.blob();
                    queue[i].resultUrl = URL.createObjectURL(blob);
                    queue[i].status = 'success';

                } catch (error) {
                    console.error("DEBUG:", error);
                    queue[i].status = 'error';
                    queue[i].log = error.message; // 记录真实原因
                }

                renderGrid();
                updateProgress(i + 1, queue.length);
            }
            isProcessing = false;
        }

        function toBase64(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
            });
        }

        function updateProgress(cur, total) {
            const percent = Math.round((cur / total) * 100);
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('percentText').innerText = percent + '%';
        }
    </script>
</body>
</html>
